#!/usr/bin/python
# --------------------------------------------------------------------------
# Class definition of LedController - utility functions for the LED-strip
#
# This class also takes care of updating the LEDs during idle time
# (e.g. for clock-simulation)
#
# Please edit /etc/nerd-alarmclock.conf to configure this thread
#
# Author: Bernhard Bablok
# License: GPL3
#
# Website: https://github.com/bablokb/nerd-alarmclock
#
# --------------------------------------------------------------------------

import time, threading, colorsys, json

try:
  import blinkt
  simulate=False
except:
  # we assume our test-environment
  simulate=True

class LedController(object):
  """ Utility functions for the LED-strip """

  BNESS  = [0.0, 0.05, 0.1, 0.2, 0.4]     # usable brightness-values
  RED    = (255,0,0)
  YELLOW = (255,255,0)
  GREEN  = (0,255,0)
  BLUE   = (0,0,255)
  COLORS = [RED,YELLOW,GREEN,BLUE]

  # initialize object   ----------------------------------------------------

  def __init__(self,settings):
    """ Constructor """
    self._settings = settings
    self._lock     = threading.Lock()
    self._brightness = 0

    # set time and brightness
    self._initialize()

    settings.add_settings_listener('led.brightness.day',self.on_brightness)
    settings.add_settings_listener('led.brightness.night',self.on_brightness)
    settings.add_settings_listener('_current_date',self.on_date)
    settings.add_settings_listener('_day_mode',self.on_day_mode)
    settings.add_alarm_provider(self.get_alarm)

    # save list of alarms in settings
    alarms = []
    for method in dir(self):
      if method.startswith("alarm_"):
        alarms.append(method[6:])
    settings.set("_led_alarms",alarms)

  # --- initialize the LEDs (brightness, time)   ----------------------------

  def _initialize(self):
    """ Initialize time and brightness """

    self._day_of_month = time.localtime().tm_mday
    self._set_day_of_month()

  # --- set the day of month   ---------------------------------------------

  def _set_day_of_month(self):
    """ show the given day of month on the led """

    self._settings.log.msg("LedController: setting day of month to: %d" % self._day_of_month)
    if not simulate:
      num_leds  = (self._day_of_month - 1) % 8 + 1
      col_index = (self._day_of_month - 1) // 8
      color = LedController.COLORS[col_index]
      # could be during an alarm, so ignore if we can't get the lock
      # (at the end of the alarm this method will be called anyhow)
      if self._lock.acquire(False):
        blinkt.clear()
        for i in range(num_leds):
          blinkt.set_pixel(i,color[0],color[1],color[2])
          blinkt.show()
        self._lock.release()

  # --- set the brightness of the LEDs   -----------------------------------

  def _set_brightness(self,value=None):
    """ Set the brightness of the leds """
    # we only use off and four levels, so scale new appropriately
    if not value is None:
      self._brightness = value
    self._settings.log.msg("LedController: setting brightness to: %d" % self._brightness)
    if not simulate:
      # could be during an alarm, so ignore if we can't get the lock
      # (at the end of the alarm this method will be called anyhow)
      if self._lock.acquire(False):
        blinkt.set_brightness(LedController.BNESS[self._brightness])
        blinkt.show()
        self._lock.release()

  # --- day-mode change listener   -----------------------------------------

  def on_day_mode(self,name,old,new):
    """ process day-mode-changes """

    value = self._settings.get("led.brightness."+new)
    self._set_brightness(value)

  # --- date change listener   ---------------------------------------------

  def on_date(self,name,old,new):
    """ process date-change events (e.g. change LEDs)"""

    self._settings.log.msg("LedController: on_date(%s,%s)" % (old,new))

    # set day-of-month
    self._day_of_month = int(new.split(':')[2])
    self._set_day_of_month()

  # --- brightness change listener   ---------------------------------------

  def on_brightness(self,name,old,new):
    """ process brightness-changes """

    self._settings.log.msg("LedController: on_brightness(%s,%s)" % (old,new))
    self._set_brightness(new)

  # --- get runnable alarm   -----------------------------------------------

  def get_alarm(self,nr,alarm):
    """ return runnable alarm """

    self._settings.log.msg("LedController: creating alarm-thread for alarm %s" % nr)

    # query alarm-settings
    try:
      cfg = json.loads(self._settings.get("alarm.%s.led" % nr))
    except:
      cfg = self._settings.get("alarm.%s.led" % nr,deep=True)

    if not cfg.has_key('name') or not cfg['name']:
      return None

    if not hasattr(self,"alarm_"+cfg['name']):
      self._settings.log.msg("LedController: unsupported alarm: %s" % cfg['name'])
      return None
      
    alarm_func=getattr(self,"alarm_"+cfg['name'])
    del cfg['name']

    # return alarm
    t = threading.Thread(target=alarm_func,args=(alarm.event,),kwargs=cfg)
    return t

  # sunrise simulation   ---------------------------------------------------

  def alarm_sunrise(self,stop_me,duration=10):
    """ sunrise simulation for the light-alarm """

    duration = int(duration)

    self._settings.log.msg(
      "LedController: running sunrise-alarm for %s minutes" % duration)

    if simulate:
      stop_me.wait(60*duration)
      self._settings.log.msg("LedController: sunrise-alarm ended")
      return

    # hue is in degrees
    HUE_START = 0                         # red
    HUE_END   = 50                        # yellow
    L_START   = 0.2

    delta   = 1.0/(duration*60)           # fraction per second
    H_delta = (HUE_END - HUE_START)*delta
    L_delta = (1.0-L_START)*delta

    # iterate from led-brightness low->high, hue start->end,
    #         saturation high->low, lightness low->high

    H          = HUE_START
    brightness = delta
    S          = 1.0
    L          = L_START

    sec = 0
    with self._lock:
      while sec <= duration*60:
        # wait one second and bail out if stopped
        if stop_me.wait(1):
          break

        # convert HSL to RGB ...
        (R,G,B) = colorsys.hls_to_rgb(H/360.0,L,S)
        R = 255*R
        G = 255*G
        B = 255*B

        # ... and show
        blinkt.set_all(R,G,B,brightness)
        blinkt.show()

        # update values
        sec        = sec + 1
        brightness = brightness + delta
        H          = H + H_delta
        L          = L + L_delta

    # reset display to standard
    self._settings.log.msg("LedController: sunrise-alarm ended")
    self._set_day_of_month()
    self._set_brightness()

  # police signal   --------------------------------------------------------

  def alarm_bluelights(self,stop_me,duration=5):
    """ simulate police signal """
    self._running_light(stop_me,duration,rgb=[0,0,255])

  # fire signal   ----------------------------------------------------------

  def alarm_redlights(self,stop_me,duration=5):
    """ simulate fire signal """
    self._running_light(stop_me,duration,rgb=[255,0,0])

  # light signal   ---------------------------------------------------------

  def alarm_whitelights(self,stop_me,duration=5):
    """ simulate fire signal """
    self._running_light(stop_me,duration,rgb=[255,255,255])

  # running light   --------------------------------------------------------

  def _running_light(self,stop_me,duration=5,rgb=[0,0,255]):
    """ running light of defined color (modified from blinkt-example larson.py) """
    
    duration = int(duration)

    self._settings.log.msg(
      "LedController: executing running_light-alarm for %s minutes" % duration)

    (r,g,b) = rgb
    values = [(0,0,0), (0,0,0), (0,0,0), (0,0,0), (0,0,0),
              (r//16,g//16,b//16),
              (r//4,g//4,b//4),
              (r,g,b),
              (r//4,g//4,b//4),
              (r//16,g//16,b//16),
              (0,0,0), (0,0,0), (0,0,0), (0,0,0), (0,0,0), (0,0,0)]

    start_time = time.time()
    end_time   = start_time + 60*duration
    now        = start_time

    if simulate:
      stop_me.wait(60*duration)
      self._settings.log.msg("LedController: running_light-alarm finished")
    else:
      with self._lock:
        blinkt.set_brightness(1.0)
        while now <= end_time:

          delta  = (now - start_time) * 16
          offset = int(abs((delta % 16) - 8))

          for i in range(8):
            (rv,gv,bv) = values[offset + i]
            blinkt.set_pixel(i,rv,gv,bv)

          blinkt.show()
          if stop_me.wait(0.1):
            break
          now = time.time()

      # reset display to standard
      self._settings.log.msg("LedController: running_light-alarm finished")
      self._set_day_of_month()
      self._set_brightness()
